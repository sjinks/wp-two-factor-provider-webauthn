!function(e,t){function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=n(e);function a(){return a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},a.apply(this,arguments)}t.__("WebAuthn is not supported by the browser.","two-factor-provider-webauthn"),t.__("Unable to get a public key credential.","two-factor-provider-webauthn");var i=t.__("The request is not allowed.","two-factor-provider-webauthn"),o=t.__("The operation is insecure.","two-factor-provider-webauthn"),c=t.__("The operation is not supported.","two-factor-provider-webauthn"),s=t.__("The operation was canceled.","two-factor-provider-webauthn"),d=t.__("You cannot use this key to log in.","two-factor-provider-webauthn"),u=t.__("This key is already registered.","two-factor-provider-webauthn"),l=t.__("This key is already registered.","two-factor-provider-webauthn"),f=t.__("Fetching registration information…","two-factor-provider-webauthn"),h=t.__("Generating credentials…","two-factor-provider-webauthn"),b=t.__("Registering credentials…","two-factor-provider-webauthn"),v=t.__("Unable to create public key credentials","two-factor-provider-webauthn"),p=t.__("The key has been registered.","two-factor-provider-webauthn"),w=t.__("Sending request…","two-factor-provider-webauthn"),y=t.__("The key has been revoked.","two-factor-provider-webauthn"),g=t.__("The key has been renamed.","two-factor-provider-webauthn");function _(e){return window.btoa(String.fromCharCode.apply(String,e))}function k(e){return window.atob(e.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(3-(3+e.length)%4))}function m(e){return Uint8Array.from(e,(function(e){return e.charCodeAt(0)}))}function x(e){return new Promise((function(t,n){r.default.ajax({method:"POST",url:ajaxurl,data:e}).done((function(e){t(e)})).fail((function(e){var t;t=e.responseJSON?e.responseJSON.data||l:e.statusText,n(new Error(t))}))}))}r.default((function(e){var t=e("#webauthn-security-keys-section");function n(e){e?t.find(".security-key-status").html('<div class="notice notice-info inline"><p>'+e+"</p></div>"):t.find(".security-key-status").text("")}function r(e){var n=e instanceof DOMException?function(e,t){switch(e.name){case"NotAllowedError":return i;case"SecurityError":return o;case"NotSupportedError":return c;case"AbortError":return s;case"InvalidStateError":return t?d:u;default:return e.message}}(e,!1):e.message,r=t.find(".registered-keys");r.siblings(".notice").remove(),r.before('<div class="notice notice-error inline" role="alert"><p>'+n+"</p></div>")}t.find(".add-webauthn-key button").on("click",(function(){t.find(".registered-keys").prev(".notice").remove(),n(f),x({action:"webauthn_preregister",_ajax_nonce:tfa_webauthn.nonce}).then((function(e){n(h),tfa_webauthn.nonce=e.data.nonce;var t=function(e){var t;return a({},e,{user:a({},e.user,{id:m(k(e.user.id))}),challenge:m(k(e.challenge)),excludeCredentials:null===(t=e.excludeCredentials)||void 0===t?void 0:t.map((function(e){return a({},e,{id:m(k(e.id))})}))})}(e.data.options);return navigator.credentials.create({publicKey:t})})).then((function(t){if(t){n(b);var r=e("#webauthn-key-name").val();return x({action:"webauthn_register",_ajax_nonce:tfa_webauthn.nonce,credential:JSON.stringify((a=t,i=a.response,{id:a.id,type:a.type,rawId:_(new Uint8Array(a.rawId)),clientExtensionResults:a.getClientExtensionResults(),response:{attestationObject:"attestationObject"in i?_(new Uint8Array(i.attestationObject)):void 0,authenticatorData:"authenticatorData"in i?_(new Uint8Array(i.authenticatorData)):void 0,signature:"signature"in i?_(new Uint8Array(i.signature)):void 0,userHandle:"userHandle"in i&&i.userHandle?_(new Uint8Array(i.userHandle)):void 0,clientDataJSON:_(new Uint8Array(a.response.clientDataJSON))}})),name:r})}var a,i;throw new Error(v)})).then((function(e){tfa_webauthn.nonce=e.data.nonce;var n=t.find(".registered-keys");n.find("tbody > tr:last-child").after(e.data.row),n.find("tbody > tr.no-items").remove(),n.before('<div class="notice notice-success inline" role="alert"><p>'+p+"</p></div>")})).catch(r).finally((function(){n(""),e("#webauthn-key-name").val("")}))})),t.find(".registered-keys").on("click","tbody .delete a",(function(a){t.find(".registered-keys").prev(".notice").remove(),a.preventDefault();var i=e(a.target),o=i.closest(".row-actions");if(!o.siblings(".confirm-revoke").length){var c=i.data("handle"),s=i.data("nonce"),d=t.find(".registered-keys"),u=e(e("#webauthn-revoke-confirm").text());o.after(u),o.siblings(".confirm-revoke").on("click",".button-secondary",(function(){o.siblings(".confirm-revoke").remove()})).on("click",".button-link-delete",(function(){return o.siblings(".confirm-revoke").hide(),n(w),x({action:"webauthn_delete_key",_ajax_nonce:s,handle:c}).then((function(){d.before('<div class="notice notice-success inline" role="alert"><p>'+y+"</p></div>"),i.closest("tr").remove(),d.find("tbody > tr").length||d.find("tbody").append(e("#webauthn-no-keys").text())})).catch(r).finally((function(){n(""),o.siblings(".confirm-revoke").remove()}))}))}})),t.find(".registered-keys").on("click","tbody .rename a",(function(a){t.find(".registered-keys").prev(".notice").remove(),a.preventDefault();var i=e(a.target),o=i.closest(".row-actions");if(!o.siblings(".rename-key").length){var c=i.data("handle"),s=i.data("nonce"),d=i.closest("td").find("span.key-name").text().trim(),u=t.find(".registered-keys"),l=e(e("#webauthn-rename-key").text());o.after(l),o.siblings(".rename-key").on("click",".button-secondary",(function(){o.siblings(".rename-key").remove()})).on("click",".button-primary",(function(){var e=o.siblings(".rename-key").find('input[type="text"]').val();return o.siblings(".rename-key").hide(),n(w),x({action:"webauthn_rename_key",_ajax_nonce:s,handle:c,name:e}).then((function(e){u.before('<div class="notice notice-success inline" role="alert"><p>'+g+"</p></div>"),i.closest("td").find("span.key-name").text(e.data.name)})).catch(r).finally((function(){n(""),o.siblings(".rename-key").remove()}))})).find('input[type="text"]').val(d)}}))}))}(jQuery,wp.i18n);
