!function(e,t){function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},n.apply(this,arguments)}t.__("WebAuthn is not supported by the browser.","two-factor-provider-webauthn"),t.__("Unable to get a public key credential.","two-factor-provider-webauthn");var r=t.__("The request is not allowed.","two-factor-provider-webauthn"),a=t.__("The operation is insecure.","two-factor-provider-webauthn"),i=t.__("The operation is not supported.","two-factor-provider-webauthn"),o=t.__("The operation was canceled.","two-factor-provider-webauthn");t.__("You cannot use this key to log in.","two-factor-provider-webauthn");var s=t.__("This key is already registered.","two-factor-provider-webauthn"),c=t.__("This key is already registered.","two-factor-provider-webauthn"),d=t.__("Fetching registration information…","two-factor-provider-webauthn"),u=t.__("Generating credentials…","two-factor-provider-webauthn"),l=t.__("Registering credentials…","two-factor-provider-webauthn"),f=t.__("Unable to create public key credentials","two-factor-provider-webauthn"),h=t.__("The key has been registered.","two-factor-provider-webauthn"),b=t.__("Sending request…","two-factor-provider-webauthn"),v=t.__("The key has been revoked.","two-factor-provider-webauthn"),w=t.__("The key has been renamed.","two-factor-provider-webauthn");function p(e){return window.btoa(String.fromCharCode.apply(String,e))}function y(e){return window.atob(e.replace(/-/g,"+").replace(/_/g,"/")+"=".repeat(3-(3+e.length)%4))}function _(e){return Uint8Array.from(e,(function(e){return e.charCodeAt(0)}))}function g(t){return new Promise((function(n,r){e.ajax({method:"POST",url:ajaxurl,data:t}).done((function(e){n(e)})).fail((function(e){var t;t=e.responseJSON?e.responseJSON.data||c:e.statusText,r(new Error(t))}))}))}e((function(e){var t=e("#webauthn-security-keys-section");function c(e){e?t.find(".security-key-status").html('<div class="notice notice-info inline"><p>'+e+"</p></div>"):t.find(".security-key-status").text("")}function k(e){var n=e instanceof DOMException?function(e,t){switch(e.name){case"NotAllowedError":return r;case"SecurityError":return a;case"NotSupportedError":return i;case"AbortError":return o;case"InvalidStateError":return s;default:return e.message}}(e):e.message,c=t.find(".registered-keys");c.siblings(".notice").remove(),c.before('<div class="tfa-webauthn-alert notice notice-error inline" role="alert"><p>'+n+"</p></div>")}t.find(".add-webauthn-key button").on("click",(function(){t.find(".registered-keys").prev(".notice").remove(),c(d),g({action:"webauthn_preregister",_ajax_nonce:tfa_webauthn.nonce,user_id:e("#user_id").val()}).then((function(e){c(u),tfa_webauthn.nonce=e.data.nonce;var t=function(e){var t;return n({},e,{user:n({},e.user,{id:_(y(e.user.id))}),challenge:_(y(e.challenge)),excludeCredentials:null===(t=e.excludeCredentials)||void 0===t?void 0:t.map((function(e){return n({},e,{id:_(y(e.id))})}))})}(e.data.options);return navigator.credentials.create({publicKey:t})})).then((function(t){if(t){c(l);var n=e("#webauthn-key-name").val();return g({action:"webauthn_register",_ajax_nonce:tfa_webauthn.nonce,credential:JSON.stringify((r=t,a=r.response,{id:r.id,type:r.type,rawId:p(new Uint8Array(r.rawId)),clientExtensionResults:r.getClientExtensionResults(),response:{attestationObject:"attestationObject"in a?p(new Uint8Array(a.attestationObject)):void 0,authenticatorData:"authenticatorData"in a?p(new Uint8Array(a.authenticatorData)):void 0,signature:"signature"in a?p(new Uint8Array(a.signature)):void 0,userHandle:"userHandle"in a&&a.userHandle?p(new Uint8Array(a.userHandle)):void 0,clientDataJSON:p(new Uint8Array(r.response.clientDataJSON))}})),user_id:e("#user_id").val(),name:n})}var r,a;throw new Error(f)})).then((function(e){tfa_webauthn.nonce=e.data.nonce;var n=t.find(".registered-keys");n.find("tbody > tr:last-child").after(e.data.row),n.find("tbody > tr.no-items").remove(),n.before('<div class="tfa-webauthn-alert notice notice-success inline" role="alert"><p>'+h+"</p></div>")})).catch(k).finally((function(){c(""),e("#webauthn-key-name").val("")}))})),t.find(".registered-keys").on("click","tbody .delete a",(function(n){t.find(".registered-keys").prev(".notice").remove(),n.preventDefault();var r=e(n.target),a=r.closest(".row-actions");if(!a.siblings(".confirm-revoke").length){var i=r.data("handle"),o=r.data("nonce"),s=t.find(".registered-keys"),d=e(e("#webauthn-revoke-confirm").text());a.after(d),a.siblings(".confirm-revoke").on("click",".button-secondary",(function(){a.siblings(".confirm-revoke").remove()})).on("click",".button-link-delete",(function(){a.siblings(".confirm-revoke").hide(),c(b),g({action:"webauthn_delete_key",_ajax_nonce:o,user_id:e("#user_id").val(),handle:i}).then((function(){s.before('<div class="tfa-webauthn-alert notice notice-success inline" role="alert"><p>'+v+"</p></div>"),r.closest("tr").remove(),s.find("tbody > tr").length||s.find("tbody").append(e("#webauthn-no-keys").text())})).catch(k).finally((function(){c(""),a.siblings(".confirm-revoke").remove()}))}))}})),t.find(".registered-keys").on("click","tbody .rename a",(function(n){t.find(".registered-keys").prev(".notice").remove(),n.preventDefault();var r=e(n.target),a=r.closest(".row-actions");if(!a.siblings(".rename-key").length){var i=r.data("handle"),o=r.data("nonce"),s=r.closest("td").find("span.key-name").text().trim(),d=t.find(".registered-keys"),u=e(e("#webauthn-rename-key").text());a.after(u),a.siblings(".rename-key").on("click",".button-secondary",(function(){a.siblings(".rename-key").remove()})).on("click",".button-primary",(function(){var t=a.siblings(".rename-key").find('input[type="text"]').val();a.siblings(".rename-key").hide(),c(b),g({action:"webauthn_rename_key",_ajax_nonce:o,user_id:e("#user_id").val(),handle:i,name:t}).then((function(e){d.before('<div class="tfa-webauthn-alert notice notice-success inline" role="alert"><p>'+w+"</p></div>"),r.closest("td").find("span.key-name").text(e.data.name)})).catch(k).finally((function(){c(""),a.siblings(".rename-key").remove()}))})).find('input[type="text"]').val(s)}}))}))}(jQuery,wp.i18n);
